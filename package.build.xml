<?xml version="1.0" encoding="utf-8"?>
<project xmlns="http://nant.sf.net/release/0.92/nant.xsd" name="Package" default="package">
	<property name="application.name" value="TestPipe" />

	<property name="nuget.package.name" value="" />
	<property name="nuget.package.version" value="" />
	<property name="nuget.exe" value="tools\nuget.exe" />

	<if test="${property::exists('pipeline.version')}">
		<property name="nuget.package.version" value="${pipeline.version}" />
	</if>

	<target name="package" description="Run nuget.exe pack on all project files">
		<foreach item="File" property="filename">
			<in>
				<items>
					<include name="source\application\**\*.csproj" />
					<include name="source\demo\**\*.csproj" />
					<include name="source\tests\**\*.csproj" />
				</items>
			</in>
			<do>
				<property name="nuget.build.file" value="${filename}" />
				<echo message="Build File: ${filename}" />

				<property name="nuget.package.name" value="${path::get-file-name-without-extension(filename)}" />
				<echo message="Package Name: ${nuget.package.name}" />

				<property name="nuget.package.path" value="${build.path}Nuget\${nuget.package.name}.${nuget.package.version}\" />
				<echo message="Package Path: ${nuget.package.path}" />

				<delete dir="${nuget.package.path}" />
				<mkdir dir="${nuget.package.path}" />

				<call target="package.single" />
			</do>
		</foreach>
	</target>

	<target name="package.single" description="Run nuget.exe pack">
		<echo message="Nuget.exe ${nuget.exe}" />
		<property name="nuget.build" value="" />
		<if test="${property::exists('build')}">
			<property name="nuget.build" value="-Build" />
		</if>
		<exec program="${nuget.exe}" failonerror="false">
			<arg value="pack" />
			<arg path="${nuget.build.file}" />
			<arg line="-Version ${nuget.package.version}" />
			<arg line="-OutputDirectory ${nuget.package.path}" />
			<arg value="-NonInteractive" />
			<arg value="${nuget.build}" />
		</exec>
	</target>
</project>